# Database Initialization Guide

## Overview

The ABED server uses PostgreSQL with Drizzle ORM for database operations. This guide explains how database tables are created and managed.

## ğŸš€ Quick Start

### Automatic Initialization (Recommended)
The server automatically creates tables when it starts if they don't exist:

```bash
cd MyProject/Server
docker-compose up postgres -d
bun run dev
```

The server will:
1. âœ… Test database connection
2. âœ… Check if tables exist
3. âœ… Create tables if missing
4. âœ… Run any pending migrations
5. âœ… Start the server

### Manual Database Management

```bash
# Check database status
bun run db:status

# Create all tables
bun run db:create

# Full setup (create + migrate + seed test data)
bun run db:setup

# Reset database (âš ï¸ destructive)
bun run db:reset

# Add test data
bun run db:seed
```

## ğŸ“Š Database Schema

### Users Table
```sql
CREATE TABLE IF NOT EXISTS "users" (
  "id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
  "password" varchar(255) NOT NULL,
  "email" varchar(255) NOT NULL,
  "character_id" varchar(255) NOT NULL,
  "last_news_received" varchar(255) NOT NULL,
  "created_at" timestamp DEFAULT now() NOT NULL,
  "updated_at" timestamp DEFAULT now() NOT NULL,
  "created_by" varchar(255) NOT NULL,
  "updated_by" varchar(255) NOT NULL,
  CONSTRAINT "users_email_unique" UNIQUE("email")
);
```

### Field Descriptions
- `id`: UUID primary key (auto-generated)
- `password`: User password (should be hashed with bcrypt)
- `email`: Unique email address for login
- `character_id`: In-game character name (unique)
- `last_news_received`: Last news item ID received
- `created_at/updated_at`: Audit timestamps
- `created_by/updated_by`: Audit trail fields

## ğŸ”§ How It Works

### Server Startup Process
1. **Connection Test**: Verify PostgreSQL is accessible
2. **Table Check**: Query `information_schema` for existing tables
3. **Migration Strategy**:
   - If tables exist: Run pending migrations
   - If no tables: Create from scratch
   - If migration fails: Manual table creation fallback

### Migration Files
Located in `src/Database/migrations/`:
- `0000_lumpy_taskmaster.sql` - Initial users table
- Generated by `drizzle-kit generate:pg`

### Fallback Strategy
If Drizzle migrations fail, the server attempts manual table creation using raw SQL from `src/Database/init.ts`.

## ğŸ“ Available Commands

| Command | Description |
|---------|-------------|
| `bun run db:status` | Show database tables and structure |
| `bun run db:create` | Create all tables manually |
| `bun run db:migrate` | Run Drizzle migrations |
| `bun run db:setup` | Full setup (create + migrate + seed) |
| `bun run db:reset` | âš ï¸ Drop and recreate all tables |
| `bun run db:seed` | Add test data |
| `bun run db:test` | Test database operations |

## ğŸ§ª Test Data

The `db:seed` command creates sample users:
- `test@abed.com` / `testpassword123` / `test_hero`
- `alice@demo.com` / `demo123ABC` / `alice_mage`
- `bob@demo.com` / `demo123ABC` / `bob_warrior`
- `charlie@demo.com` / `demo123ABC` / `charlie_rogue`

Perfect for testing login/registration flows!

## ğŸ³ Docker Configuration

```yaml
postgres:
  image: postgres:15
  container_name: ABED_POSTGRES
  ports:
    - "40316:5432"  # John 3:16 port!
  environment:
    POSTGRES_DB: abed_db
    POSTGRES_USER: abed_user
    POSTGRES_PASSWORD: abed_password
```

## ğŸ” Troubleshooting

### Tables Not Created
```bash
# Check if PostgreSQL is running
docker ps | grep postgres

# Start database
docker-compose up postgres -d

# Check connection
bun run db:status
```

### Migration Failures
```bash
# Try manual table creation
bun run db:create

# Or full reset
bun run db:reset
```

### Connection Issues
- Verify port 40316 is not blocked
- Check environment variables in `.env`
- Ensure database container is healthy

### Permission Errors
```bash
# Connect to database container
docker exec -it ABED_POSTGRES psql -U abed_user -d abed_db

# Check user permissions
\du
```

## ğŸ” Production Considerations

### Security
- [ ] Change default database credentials
- [ ] Use environment-specific passwords
- [ ] Enable SSL connections
- [ ] Implement password hashing (bcrypt)

### Performance
- [ ] Add indexes for frequently queried fields
- [ ] Implement connection pooling optimization
- [ ] Set up database monitoring

### Backup Strategy
- [ ] Automated database backups
- [ ] Point-in-time recovery setup
- [ ] Test restore procedures

## ğŸš€ Adding New Tables

1. **Update Schema**: Add new table to `src/Database/Schema/`
2. **Generate Migration**: `bun run db:generate`
3. **Update Init**: Add manual creation fallback in `init.ts`
4. **Test**: `bun run db:test`

Example new table:
```typescript
// src/Database/Schema/items.ts
export const items = pgTable("items", {
  id: uuid("id").primaryKey().defaultRandom(),
  name: varchar("name", { length: 255 }).notNull(),
  type: varchar("type", { length: 100 }).notNull(),
  // ... more fields
});
```

## ğŸ“ˆ Database Status

Check current status anytime:
```bash
bun run db:status
```

Example output:
```
âœ… Database connection successful

ğŸ“Š Database Tables:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. users

ğŸ‘¤ Users Table Structure:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  id: uuid NOT NULL (gen_random_uuid())
  password: character varying NOT NULL
  email: character varying NOT NULL
  character_id: character varying NOT NULL
  last_news_received: character varying NOT NULL
  created_at: timestamp DEFAULT now()
  updated_at: timestamp DEFAULT now()
  created_by: character varying NOT NULL
  updated_by: character varying NOT NULL

ğŸ“ˆ Records: 4 users
```

## âœ… Best Practices

1. **Always test connection first**
2. **Use transactions for multiple operations**
3. **Handle migration failures gracefully**
4. **Keep audit trails (created_by, updated_by)**
5. **Use UUID for primary keys**
6. **Validate data before database operations**
7. **Log all database operations**

The database initialization is designed to be **robust and automatic** - just start the server and it handles the rest! ğŸ‰
